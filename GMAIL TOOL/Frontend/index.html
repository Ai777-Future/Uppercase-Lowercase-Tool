<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bulk Personalized Email Sender</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444;
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:linear-gradient(120deg,#0b1023,#0f172a); color:var(--text)}
    .wrap{max-width:1000px; margin:40px auto; padding:24px}
    h1{font-size:28px; margin:0 0 16px}
    p.hint{color:var(--muted); margin:0 0 20px}
    .grid{display:grid; gap:16px; grid-template-columns:1fr}
    @media (min-width:920px){ .grid{ grid-template-columns:1.1fr .9fr } }
    .card{background:rgba(17,24,39,.7); border:1px solid var(--border); border-radius:12px; padding:16px; backdrop-filter: blur(6px)}
    label{display:block; font-weight:600; margin:10px 0 6px}
    input[type="text"], textarea{
      width:100%; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px;
      padding:12px 14px; outline:none; transition:border .2s, box-shadow .2s; resize:vertical
    }
    input[type="text"]:focus, textarea:focus{ border-color:#334155; box-shadow:0 0 0 4px rgba(96,165,250,.12)}
    textarea.msg{min-height:180px}
    textarea.csv{min-height:220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:none; border-radius:10px; padding:10px 14px; color:#0b1220; font-weight:700; cursor:pointer;
      background:linear-gradient(135deg,var(--accent),#16a34a); transition:transform .06s ease, filter .2s
    }
    .btn.sec{ background:linear-gradient(135deg,var(--accent2),#3b82f6); color:#06111e }
    .btn.ghost{ background:#0b1220; color:var(--text); border:1px solid var(--border) }
    .btn:active{ transform:translateY(1px) scale(.99) }
    .stat{font-size:14px; color:var(--muted)}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border-bottom:1px solid var(--border); padding:8px 6px; text-align:left; font-size:14px}
    .ok{color:#22c55e} .bad{color:var(--danger)}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#0b1220; color:var(--muted); font-size:12px; border:1px solid var(--border)}
    .preview{white-space:pre-wrap; background:#0b1220; border:1px dashed #334155; padding:12px; border-radius:10px}
    .footer{margin-top:18px; color:var(--muted); font-size:12px}
    code{background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìß Bulk Personalized Email Sender</h1>
    <p class="hint">Placeholders ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü‡•á‡§°: <code>{{firstName}}</code>, <code>{{lastName}}</code>. Recipients CSV header ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è: <code>firstName,lastName,email</code></p>

    <div class="grid">
      <div class="card">
        <label for="subject">Subject</label>
        <input id="subject" type="text" placeholder="e.g. Welcome {{firstName}} ‚Äì Your Access Inside!" />

        <label for="message">Message</label>
        <textarea id="message" class="msg" placeholder="Write your email here. You can use {{firstName}} and {{lastName}} for personalization."></textarea>

        <div class="row">
          <button id="btnPreview" class="btn sec">üîç Preview</button>
          <button id="btnSend" class="btn" disabled>üöÄ Send Emails</button>
          <button id="btnClear" class="btn ghost">üßπ Clear</button>
          <span id="stats" class="stat"></span>
        </div>

        <div id="previewWrap" style="display:none; margin-top:14px">
          <div class="row"><span class="pill" id="countPill">0 recipients</span><span class="pill" id="okPill">0 valid</span><span class="pill" id="badPill">0 invalid</span></div>
          <div class="row" style="margin-top:10px">
            <div class="card" style="flex:1">
              <strong>Sample Personalized Preview</strong>
              <div id="samplePreview" class="preview">‚Äî</div>
            </div>
          </div>
          <div class="card" style="margin-top:12px">
            <strong>Parsed Recipients</strong>
            <table id="tbl"><thead><tr><th>#</th><th>First</th><th>Last</th><th>Email</th><th>Status</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <div class="card">
        <label for="csv">Recipients (CSV)</label>
        <textarea id="csv" class="csv" placeholder="firstName,lastName,email
Amit,Sharma,amit@example.com
Neha,Gupta,neha@example.com"></textarea>
        <div class="footer">
          Tips:
          <ul>
            <li>every line has a recipient . Commas ‡§∏‡•á ‡§Ö‡§≤‡§ó ‡§ï‡§∞‡•ã.</li>
            <li>Duplicates auto-filter ‡§π‡•ã ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á.</li>
            <li>Invalid emails ‡§≠‡•á‡§ú‡•á ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á.</li>
          </ul>
        </div>
      </div>
    </div>

    <p class="footer">Made with ‚ù§Ô∏è. please opt-in contacts for send email</p>
  </div>

<script>
  const $ = sel => document.querySelector(sel);
  const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/i;

  function parseCSV(text){
    let lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(!lines.length) return {rows:[], bad:[]};
    // header check
    let [h1,h2,h3] = lines[0].split(/\s*,\s*/);
    let start = 0;
    if([h1,h2,h3].map(s=>(s||"").toLowerCase()).join(",") === "firstname,lastname,email"){
      start = 1;
    }
    const seen = new Set();
    const rows = [];
    const bad = [];
    for(let i=start;i<lines.length;i++){
      const [firstName="", lastName="", email=""] = lines[i].split(/\s*,\s*/);
      const rec = {firstName:firstName.trim(), lastName:lastName.trim(), email:email.trim()};
      const key = rec.email.toLowerCase();
      if(!rec.firstName || !rec.email || !emailRx.test(rec.email) || seen.has(key)){
        bad.push({line:i+1, ...rec, reason: seen.has(key) ? "duplicate" : (!emailRx.test(rec.email)?"invalid email":"missing field")});
        continue;
      }
      seen.add(key);
      rows.push(rec);
    }
    return {rows, bad};
  }

  function interpolate(tpl, data){
    return tpl
      .replaceAll(/{{\s*firstName\s*}}/gi, data.firstName || "")
      .replaceAll(/{{\s*lastName\s*}}/gi, data.lastName || "");
  }

  function renderTable(rows, bad){
    const tbody = $("#tbl tbody");
    tbody.innerHTML = "";
    rows.forEach((r,idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${idx+1}</td><td>${r.firstName}</td><td>${r.lastName||""}</td><td>${r.email}</td><td class="ok">valid</td>`;
      tbody.appendChild(tr);
    });
    bad.forEach(b=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>‚Äî</td><td>${b.firstName||""}</td><td>${b.lastName||""}</td><td>${b.email||""}</td><td class="bad">${b.reason}</td>`;
      tbody.appendChild(tr);
    });
  }

  let parsed = {rows:[], bad:[]};

  $("#btnPreview").addEventListener("click", ()=>{
    parsed = parseCSV($("#csv").value);
    $("#countPill").textContent = `${parsed.rows.length + parsed.bad.length} recipients`;
    $("#okPill").textContent = `${parsed.rows.length} valid`;
    $("#badPill").textContent = `${parsed.bad.length} invalid`;
    renderTable(parsed.rows, parsed.bad);

    const sample = parsed.rows[0] || {firstName:"Amit", lastName:"Sharma"};
    const subject = $("#subject").value || "Hello {{firstName}}";
    const message = $("#message").value || "Hi {{firstName}},\nWelcome!";
    $("#samplePreview").textContent = "Subject: " + interpolate(subject, sample) + "\n\n" + interpolate(message, sample);

    $("#previewWrap").style.display = "block";
    $("#btnSend").disabled = parsed.rows.length === 0 || ($("#subject").value.trim()==="" || $("#message").value.trim()==="");
    $("#stats").textContent = parsed.rows.length ? "Ready to send." : "Add valid recipients + subject + message.";
  });

  $("#btnClear").addEventListener("click", ()=>{
    $("#subject").value = "";
    $("#message").value = "";
    $("#csv").value = "";
    $("#previewWrap").style.display = "none";
    $("#btnSend").disabled = true;
    $("#stats").textContent = "";
  });

  $("#btnSend").addEventListener("click", async ()=>{
    const subject = $("#subject").value.trim();
    const message = $("#message").value.trim();
    if(!subject || !message || parsed.rows.length === 0){ alert("Missing subject/message or recipients."); return; }

    $("#btnSend").disabled = true; $("#btnSend").textContent = "Sending‚Ä¶";
    $("#stats").textContent = "Sending emails‚Ä¶";

    try{
      const res = await fetch("http://localhost:8080/send",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          subject,
          message,
          recipients: parsed.rows
        })
      });
      const data = await res.json();
      const ok = data.results.filter(r=>r.ok).length;
      const bad = data.results.length - ok;
      $("#stats").textContent = `Sent: ${ok}, Failed: ${bad}`;
      // mark per row
      const tbody = $("#tbl tbody");
      [...tbody.rows].forEach((tr,i)=>{
        const r = data.results[i];
        if(!r) return;
        const td = tr.cells[4];
        td.textContent = r.ok ? "sent" : ("failed: " + (r.error||""));
        td.className = r.ok ? "ok" : "bad";
      });
    }catch(err){
      $("#stats").textContent = "Error: " + err.message;
      alert("Failed: " + err.message);
    }finally{
      $("#btnSend").disabled = false; $("#btnSend").textContent = "üöÄ Send Emails";
    }
  });
</script>
</body>
</html>
